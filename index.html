<!DOCTYPE html>
<html>
<head>
  <title>Monitoreo Nevera - PZEM-004T</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Incluir Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.js"></script>
</head>
<body>
  <div class="data-box">
    <h2>Monitoreo Nevera</h2>
    <!-- Botón para alternar tema -->
    <button id="theme-toggle" class="theme-button">Cambiar a Tema Oscuro</button>
    <p><span class="label">Voltaje:</span> <span class="value" id="voltage" data-unit="V">Cargando...</span></p>
    <p><span class="label">Corriente:</span> <span class="value" id="current" data-unit="A">Cargando...</span></p>
    <p><span class="label">Potencia:</span> <span class="value" id="power" data-unit="W">Cargando...</span></p>
    <p><span class="label">Energía:</span> <span class="value" id="energy" data-unit="kWh">Cargando...</span></p>
    <p><span class="label">Factor de Potencia:</span> <span class="value" id="pf" data-unit="">Cargando...</span></p>
    <p><span class="label">Tiempo Potencia 70-123 W:</span> <span class="value" id="timePower70to120" data-unit="">Cargando...</span></p>
    <p><span class="label">Tiempo Encendido:</span> <span class="value" id="timeOn" data-unit="">Cargando...</span></p>
    <p><span class="label">Tiempo Apagado:</span> <span class="value" id="timeOff" data-unit="">Cargando...</span></p>
    <!-- Gráfico -->
    <div class="chart-container">
      <canvas id="pzemChart"></canvas>
    </div>
  </div>

  <script>
    // Función para convertir segundos a formato HH:MM:SS
    function secondsToHMS(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Función para obtener los datos de ThingSpeak
    function fetchData() {
      const apiUrl = "https://api.thingspeak.com/channels/2907670/feeds.json?api_key=RHC260CCGJTB5IAX&results=5";

      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (!data.feeds || data.feeds.length === 0) {
            throw new Error("No se encontraron datos en la respuesta de ThingSpeak");
          }
          const feeds = data.feeds;
          // Mostrar los datos más recientes
          const latestFeed = feeds[feeds.length - 1];
          const voltage = parseFloat(latestFeed.field1);
          const current = parseFloat(latestFeed.field2);
          const power = parseFloat(latestFeed.field3);
          document.getElementById("voltage").innerText = voltage.toFixed(1);
          document.getElementById("current").innerText = current.toFixed(2);
          document.getElementById("power").innerText = power.toFixed(1);
          document.getElementById("energy").innerText = latestFeed.field4;
          document.getElementById("timePower70to120").innerText = secondsToHMS(parseInt(latestFeed.field5));
          document.getElementById("pf").innerText = latestFeed.field6;
          document.getElementById("timeOn").innerText = secondsToHMS(parseInt(latestFeed.field7));
          document.getElementById("timeOff").innerText = secondsToHMS(parseInt(latestFeed.field8));

          // Resaltar si la potencia está fuera del rango 70-123 W
          const powerRow = document.getElementById("power").parentElement;
          if (power < 70 || power > 123) {
            powerRow.classList.add("alert");
          } else {
            powerRow.classList.remove("alert");
          }

          // Preparar datos para el gráfico
          const labels = feeds.map((feed, index) => `Medición ${feeds.length - index}`);
          const voltages = feeds.map(feed => parseFloat(feed.field1));
          const currents = feeds.map(feed => parseFloat(feed.field2));
          const powers = feeds.map(feed => parseFloat(feed.field3));

          // Actualizar el gráfico
          updateChart(labels, voltages, currents, powers);
        })
        .catch(error => {
          console.error("Error al obtener datos:", error.message);
          document.getElementById("voltage").innerText = "Error";
          document.getElementById("current").innerText = "Error";
          document.getElementById("power").innerText = "Error";
          document.getElementById("energy").innerText = "Error";
          document.getElementById("timePower70to120").innerText = "Error";
          document.getElementById("pf").innerText = "Error";
          document.getElementById("timeOn").innerText = "Error";
          document.getElementById("timeOff").innerText = "Error";
        });
    }

    // Configuración inicial del gráfico
    const ctx = document.getElementById("pzemChart").getContext("2d");
    const pzemChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Voltaje (V)",
            data: [],
            borderColor: "#0277bd",
            fill: false,
          },
          {
            label: "Corriente (A)",
            data: [],
            borderColor: "#ff6f61",
            fill: false,
          },
          {
            label: "Potencia (W)",
            data: [],
            borderColor: "#4caf50",
            fill: false,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Valor",
            },
          },
          x: {
            title: {
              display: true,
              text: "Tiempo",
            },
          },
        },
      },
    });

    // Función para actualizar el gráfico
    function updateChart(labels, voltages, currents, powers) {
      pzemChart.data.labels = labels;
      pzemChart.data.datasets[0].data = voltages;
      pzemChart.data.datasets[1].data = currents;
      pzemChart.data.datasets[2].data = powers;
      pzemChart.update();
    }

    // Llamar a fetchData con un retraso inicial
    setTimeout(fetchData, 2000); // Espera 2 segundos para evitar problemas con Cloudflare
    setInterval(fetchData, 15000);

    // Alternar tema claro/oscuro
    const themeToggle = document.getElementById("theme-toggle");
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-theme");
      if (document.body.classList.contains("dark-theme")) {
        themeToggle.innerText = "Cambiar a Tema Claro";
      } else {
        themeToggle.innerText = "Cambiar a Tema Oscuro";
      }
    });
  </script>
</body>
</html>
